{% extends "base.html" %}

{% block title %}Pipeline Monitor - {{ run.work_id }}{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
{% endblock %}

{% block content %}
<div class="mb-6">
    <h1 class="text-2xl font-bold">Pipeline Monitor</h1>
    <p class="text-muted">Work ID: <code class="text-sm bg-gray-100 dark:bg-gray-700 px-1.5 py-0.5 rounded">{{ run.work_id }}</code> &mdash; <span class="badge badge-{{ run.status }}">{{ run.status }}</span></p>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <section>
        <h2 class="text-xl font-semibold mb-4">Pipeline Diagram</h2>
        <div class="mermaid-container">
            <pre class="mermaid" id="mermaid-diagram">
{{ mermaid_diagram }}
            </pre>
        </div>
    </section>

    <section>
        <h2 class="text-xl font-semibold mb-4">Run Info</h2>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
            <dl class="space-y-3">
                <dt class="text-sm text-muted">Task</dt>
                <dd class="font-medium"><code class="text-sm bg-gray-100 dark:bg-gray-700 px-1.5 py-0.5 rounded">{{ run.task_path }}</code></dd>
                <dt class="text-sm text-muted">Started</dt>
                <dd class="font-medium">{{ run.started_at or 'N/A' }}</dd>
                <dt class="text-sm text-muted">Current Stage</dt>
                <dd class="font-medium"><code class="text-sm bg-gray-100 dark:bg-gray-700 px-1.5 py-0.5 rounded">{{ run.current_stage or 'initializing' }}</code></dd>
            </dl>
        </div>
    </section>
</div>

<h2 class="text-xl font-semibold mb-4">Stage Progress</h2>
<div hx-ext="sse" sse-connect="/api/pipeline/{{ run.id }}/stream">
    <ul class="stage-list">
        {% for stage in stages | default([]) %}
        <li class="stage-item {{ stage.status }}">
            <span class="badge badge-{{ stage.status }}">{{ stage.status }}</span>
            <strong>{{ stage.stage_name }}</strong>
            {% if stage.started_at %}
            <small class="text-muted">{{ stage.started_at }}</small>
            {% endif %}
        </li>
        {% endfor %}
    </ul>

    <h3 class="text-lg font-semibold mb-3 mt-6">Live Updates</h3>
    <div id="stage-updates" sse-swap="stage_update" hx-swap="beforeend">
    </div>
</div>

<h2 class="text-xl font-semibold mb-4 mt-6">Output Log</h2>
<div class="json-viewer" id="output-log"
     hx-get="/api/pipeline/{{ run.id }}/log"
     hx-trigger="every 3s"
     hx-swap="innerHTML">
    Waiting for output...
</div>
{% endblock %}

{% block scripts %}
<script>
    mermaid.initialize({ startOnLoad: true, theme: 'neutral' });
</script>
{% endblock %}
