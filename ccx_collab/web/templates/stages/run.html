{% extends "base.html" %}

{% block title %}{{ _('run_stage') }} - {{ stage_name }}{% endblock %}

{% block content %}
<div class="mb-6">
    <h1 class="text-2xl font-bold capitalize">{{ stage_name }}</h1>
    <p class="text-muted">{{ stage_info.description }}</p>
</div>

<div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6" x-data="stageRunner()">
    <form @submit.prevent="runStage">
        {% for field in stage_info.fields %}
        <div class="mb-4">
            <label class="block text-sm font-medium mb-1">
                {{ field.label }}
                {% if field.required %}<span class="text-red-500">*</span>{% endif %}
            </label>
            {% if field.type == 'select' %}
            <select x-model="params['{{ field.name }}']"
                    class="border rounded-lg px-3 py-2 w-full bg-white dark:bg-gray-700 dark:border-gray-600"
                    {% if field.required %}required{% endif %}>
                <option value="">Select...</option>
                {% for opt in field.get('options', []) %}
                <option value="{{ opt }}">{{ opt }}</option>
                {% endfor %}
            </select>
            {% elif field.type == 'file' %}
            <input type="text" x-model="params['{{ field.name }}']"
                   class="border rounded-lg px-3 py-2 w-full bg-white dark:bg-gray-700 dark:border-gray-600"
                   placeholder="Path to file..."
                   list="files-{{ field.name }}"
                   {% if field.required %}required{% endif %}>
            <datalist id="files-{{ field.name }}">
                {% for f in available_files.get('tasks', []) %}
                <option value="{{ f }}">
                {% endfor %}
                {% for f in available_files.get('results', []) %}
                <option value="{{ f }}">
                {% endfor %}
            </datalist>
            {% else %}
            <input type="text" x-model="params['{{ field.name }}']"
                   class="border rounded-lg px-3 py-2 w-full bg-white dark:bg-gray-700 dark:border-gray-600"
                   {% if field.required %}required{% endif %}>
            {% endif %}
        </div>
        {% endfor %}

        <div class="mb-4">
            <label class="flex items-center gap-2 text-sm">
                <input type="checkbox" x-model="simulate" class="mr-1">
                {{ _('simulate_mode') }}
            </label>
        </div>

        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                :disabled="running">
            <span x-show="!running">{{ _('run_stage') }}</span>
            <span x-show="running">Running...</span>
        </button>
    </form>

    <template x-if="result">
        <div class="mt-6 p-4 rounded-lg" :class="result.status === 'completed' ? 'bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800' : 'bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800'">
            <div class="flex items-center gap-2 mb-2">
                <span class="badge" :class="result.status === 'completed' ? 'badge-completed' : 'badge-failed'" x-text="result.status"></span>
                <span class="text-sm text-muted">Exit code: <span x-text="result.exit_code"></span></span>
            </div>
            <template x-if="result.error">
                <p class="text-sm text-red-600 dark:text-red-400" x-text="result.error"></p>
            </template>
        </div>
    </template>
</div>

<a href="/stages" class="inline-block px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 text-sm">
    Back to Stages
</a>
{% endblock %}

{% block scripts %}
<script>
function stageRunner() {
    return {
        params: {},
        simulate: false,
        running: false,
        result: null,
        async runStage() {
            this.running = true;
            this.result = null;
            try {
                const resp = await fetch('/api/stages/{{ stage_name }}/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ simulate: this.simulate, params: this.params }),
                });
                this.result = await resp.json();
            } catch (e) {
                this.result = { status: 'error', exit_code: -1, error: e.message };
            }
            this.running = false;
        }
    };
}
</script>
{% endblock %}
