{% extends "base.html" %}

{% block title %}History{% endblock %}

{% block content %}
<div class="mb-6">
    <h1 class="text-2xl font-bold">Pipeline History</h1>
    <p class="text-muted">Past pipeline executions</p>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
    <div>
        <label class="block text-sm font-medium mb-1" for="status-filter">Filter by status</label>
        <select id="status-filter"
                hx-get="/history"
                hx-target="body"
                hx-push-url="true"
                name="status"
                class="border rounded-lg px-3 py-2 bg-white dark:bg-gray-700 dark:border-gray-600 w-full">
            <option value="" {% if not filter_status %}selected{% endif %}>All</option>
            <option value="completed" {% if filter_status == 'completed' %}selected{% endif %}>Completed</option>
            <option value="failed" {% if filter_status == 'failed' %}selected{% endif %}>Failed</option>
            <option value="running" {% if filter_status == 'running' %}selected{% endif %}>Running</option>
            <option value="cancelled" {% if filter_status == 'cancelled' %}selected{% endif %}>Cancelled</option>
        </select>
    </div>
    <div class="flex items-end">
        <a href="/history/charts" class="inline-block px-4 py-2 border border-blue-600 text-blue-600 rounded-lg hover:bg-blue-50 dark:hover:bg-blue-900/20 text-sm">View Analytics</a>
    </div>
</div>

<div class="overflow-x-auto">
    <table class="w-full text-sm">
        <thead class="bg-gray-50 dark:bg-gray-700">
            <tr>
                <th class="px-4 py-3 text-left font-medium">Work ID</th>
                <th class="px-4 py-3 text-left font-medium">Task</th>
                <th class="px-4 py-3 text-left font-medium">Status</th>
                <th class="px-4 py-3 text-left font-medium">Started</th>
                <th class="px-4 py-3 text-left font-medium">Finished</th>
                <th class="px-4 py-3 text-left font-medium">Duration</th>
            </tr>
        </thead>
        <tbody>
            {% for run in runs | default([]) %}
            <tr>
                <td class="px-4 py-3 border-t border-gray-100 dark:border-gray-700"><a href="/history/{{ run.id }}" class="text-blue-600 hover:underline">{{ run.work_id }}</a></td>
                <td class="px-4 py-3 border-t border-gray-100 dark:border-gray-700"><code class="text-sm bg-gray-100 dark:bg-gray-700 px-1.5 py-0.5 rounded">{{ run.task_path | default('N/A') }}</code></td>
                <td class="px-4 py-3 border-t border-gray-100 dark:border-gray-700"><span class="badge badge-{{ run.status }}">{{ run.status }}</span></td>
                <td class="px-4 py-3 border-t border-gray-100 dark:border-gray-700"><small class="text-muted">{{ run.started_at or '-' }}</small></td>
                <td class="px-4 py-3 border-t border-gray-100 dark:border-gray-700"><small class="text-muted">{{ run.finished_at or '-' }}</small></td>
                <td class="px-4 py-3 border-t border-gray-100 dark:border-gray-700"><small class="text-muted">{{ run.duration | default('-') }}</small></td>
            </tr>
            {% endfor %}
            {% if not runs %}
            <tr>
                <td colspan="6" class="px-4 py-3 border-t border-gray-100 dark:border-gray-700 text-muted">No pipeline runs found.</td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>

{% if total_pages is defined and total_pages > 1 %}
<nav class="flex justify-center gap-4 mt-6">
    {% if page > 1 %}
    <a href="/history?page={{ page - 1 }}{% if filter_status %}&status={{ filter_status }}{% endif %}" class="inline-block px-4 py-2 border border-blue-600 text-blue-600 rounded-lg hover:bg-blue-50 dark:hover:bg-blue-900/20 text-sm">Previous</a>
    {% endif %}
    <span class="self-center text-sm text-muted">Page {{ page }} of {{ total_pages }}</span>
    {% if page < total_pages %}
    <a href="/history?page={{ page + 1 }}{% if filter_status %}&status={{ filter_status }}{% endif %}" class="inline-block px-4 py-2 border border-blue-600 text-blue-600 rounded-lg hover:bg-blue-50 dark:hover:bg-blue-900/20 text-sm">Next</a>
    {% endif %}
</nav>
{% endif %}
{% endblock %}
