{% extends "base.html" %}

{% block title %}History{% endblock %}

{% block content %}
<hgroup>
    <h1>Pipeline History</h1>
    <p>Past pipeline executions</p>
</hgroup>

<div class="grid" style="margin-bottom: 1.5rem;">
    <div>
        <label for="status-filter">Filter by status</label>
        <select id="status-filter"
                hx-get="/history"
                hx-target="body"
                hx-push-url="true"
                name="status">
            <option value="" {% if not filter_status %}selected{% endif %}>All</option>
            <option value="completed" {% if filter_status == 'completed' %}selected{% endif %}>Completed</option>
            <option value="failed" {% if filter_status == 'failed' %}selected{% endif %}>Failed</option>
            <option value="running" {% if filter_status == 'running' %}selected{% endif %}>Running</option>
            <option value="cancelled" {% if filter_status == 'cancelled' %}selected{% endif %}>Cancelled</option>
        </select>
    </div>
    <div style="display: flex; align-items: end;">
        <a href="/history/charts" role="button" class="outline">View Analytics</a>
    </div>
</div>

<figure>
    <table>
        <thead>
            <tr>
                <th>Work ID</th>
                <th>Task</th>
                <th>Status</th>
                <th>Started</th>
                <th>Finished</th>
                <th>Duration</th>
            </tr>
        </thead>
        <tbody>
            {% for run in runs | default([]) %}
            <tr>
                <td><a href="/history/{{ run.id }}">{{ run.work_id }}</a></td>
                <td><code>{{ run.task_path | default('N/A') }}</code></td>
                <td><span class="badge badge-{{ run.status }}">{{ run.status }}</span></td>
                <td><small>{{ run.started_at or '-' }}</small></td>
                <td><small>{{ run.finished_at or '-' }}</small></td>
                <td><small>{{ run.duration | default('-') }}</small></td>
            </tr>
            {% endfor %}
            {% if not runs %}
            <tr>
                <td colspan="6">No pipeline runs found.</td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</figure>

{% if total_pages is defined and total_pages > 1 %}
<nav style="display: flex; justify-content: center; gap: 1rem;">
    {% if page > 1 %}
    <a href="/history?page={{ page - 1 }}{% if filter_status %}&status={{ filter_status }}{% endif %}" role="button" class="outline">Previous</a>
    {% endif %}
    <span style="align-self: center;">Page {{ page }} of {{ total_pages }}</span>
    {% if page < total_pages %}
    <a href="/history?page={{ page + 1 }}{% if filter_status %}&status={{ filter_status }}{% endif %}" role="button" class="outline">Next</a>
    {% endif %}
</nav>
{% endif %}
{% endblock %}
