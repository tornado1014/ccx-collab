{% extends "base.html" %}

{% block title %}Run Detail - {{ run.work_id }}{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
{% endblock %}

{% block content %}
<div class="mb-6">
    <h1 class="text-2xl font-bold">Run Detail</h1>
    <p class="text-muted">Work ID: <code class="text-sm bg-gray-100 dark:bg-gray-700 px-1.5 py-0.5 rounded">{{ run.work_id }}</code></p>
</div>

<div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
    <div class="font-semibold text-lg mb-4">Pipeline Run Info</div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
            <dl class="space-y-3">
                <dt class="text-sm text-muted">Run ID</dt>
                <dd class="font-medium"><code class="text-sm bg-gray-100 dark:bg-gray-700 px-1.5 py-0.5 rounded">{{ run.id }}</code></dd>
                <dt class="text-sm text-muted">Work ID</dt>
                <dd class="font-medium"><code class="text-sm bg-gray-100 dark:bg-gray-700 px-1.5 py-0.5 rounded">{{ run.work_id }}</code></dd>
                <dt class="text-sm text-muted">Task Path</dt>
                <dd class="font-medium"><code class="text-sm bg-gray-100 dark:bg-gray-700 px-1.5 py-0.5 rounded">{{ run.task_path }}</code></dd>
            </dl>
        </div>
        <div>
            <dl class="space-y-3">
                <dt class="text-sm text-muted">Status</dt>
                <dd class="font-medium"><span class="badge badge-{{ run.status }}">{{ run.status }}</span></dd>
                <dt class="text-sm text-muted">Started</dt>
                <dd class="font-medium">{{ run.started_at or 'N/A' }}</dd>
                <dt class="text-sm text-muted">Finished</dt>
                <dd class="font-medium">{{ run.finished_at or 'N/A' }}</dd>
            </dl>
        </div>
    </div>
</div>

<h2 class="text-xl font-semibold mb-4">Pipeline Diagram</h2>
<div class="mermaid-container">
    <pre class="mermaid">
{{ mermaid_diagram }}
    </pre>
</div>

<h2 class="text-xl font-semibold mb-4 mt-6">Stage Results</h2>
<div class="overflow-x-auto">
    <table class="w-full text-sm">
        <thead class="bg-gray-50 dark:bg-gray-700">
            <tr>
                <th class="px-4 py-3 text-left font-medium">#</th>
                <th class="px-4 py-3 text-left font-medium">Stage</th>
                <th class="px-4 py-3 text-left font-medium">Status</th>
                <th class="px-4 py-3 text-left font-medium">Started</th>
                <th class="px-4 py-3 text-left font-medium">Finished</th>
                <th class="px-4 py-3 text-left font-medium">Details</th>
            </tr>
        </thead>
        <tbody>
            {% for stage in stages | default([]) %}
            <tr>
                <td class="px-4 py-3 border-t border-gray-100 dark:border-gray-700">{{ loop.index }}</td>
                <td class="px-4 py-3 border-t border-gray-100 dark:border-gray-700"><strong>{{ stage.stage_name }}</strong></td>
                <td class="px-4 py-3 border-t border-gray-100 dark:border-gray-700"><span class="badge badge-{{ stage.status }}">{{ stage.status }}</span></td>
                <td class="px-4 py-3 border-t border-gray-100 dark:border-gray-700"><small class="text-muted">{{ stage.started_at or '-' }}</small></td>
                <td class="px-4 py-3 border-t border-gray-100 dark:border-gray-700"><small class="text-muted">{{ stage.finished_at or '-' }}</small></td>
                <td class="px-4 py-3 border-t border-gray-100 dark:border-gray-700">
                    {% if stage.result_json %}
                    <details>
                        <summary class="cursor-pointer text-blue-600 hover:underline text-sm">View JSON</summary>
                        <div class="json-viewer">{{ stage.result_json }}</div>
                    </details>
                    {% else %}
                    <small class="text-muted">-</small>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            {% if not stages %}
            <tr>
                <td colspan="6" class="px-4 py-3 border-t border-gray-100 dark:border-gray-700 text-muted">No stage results recorded.</td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<div class="quick-actions mt-6">
    <a href="/history" class="inline-block px-4 py-2 border border-blue-600 text-blue-600 rounded-lg hover:bg-blue-50 dark:hover:bg-blue-900/20 text-sm">Back to History</a>
    <a href="/" class="inline-block px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 text-sm">Dashboard</a>
</div>
{% endblock %}

{% block scripts %}
<script>
    mermaid.initialize({ startOnLoad: true, theme: 'neutral' });
</script>
{% endblock %}
